<nav class="navbar">
    <div class="nav-container">
        <a href="index.html" class="logo">Purely</a>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="products.html">Products</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
        <div class="nav-icons">
            <span id="search-icon" style="cursor: pointer;" onclick="window.openSearchModal()">üîç</span>
            <span id="cart-icon" style="display: flex; align-items: center; cursor: pointer;" onclick="window.location.href='cart.html'">
                üõí
                <span id="cart-count" class="cart-badge">0</span>
            </span>
            <button class="login-btn" id="login-btn" onclick="window.handleLoginClick ? window.handleLoginClick() : window.location.href='auth.html'">Login</button>
            <button class="login-btn" id="user-profile-btn" style="display: none; background: #4b0082; color: white;" onclick="window.handleProfileClick ? window.handleProfileClick() : null"></button>
        </div>
    </div>
</nav>

<!-- Search Modal -->
<div id="search-modal" class="search-modal" style="display: none;">
    <div class="search-modal-content">
        <span class="search-close" onclick="window.closeSearchModal()">&times;</span>
        <h2>Search Products</h2>
        <input type="text" id="search-input" class="search-input" placeholder="Search for products..." onkeyup="window.performSearch(this.value)">
        <div id="search-results" class="search-results"></div>
    </div>
</div>

<script>
    // Define functions in window scope immediately
    window.handleLoginClick = function() {
        const user = JSON.parse(localStorage.getItem('purely_current_user'));
        const isAdmin = localStorage.getItem('purely_is_admin') === 'true';
        
        if (user) {
            const destination = isAdmin ? 'admin-dashboard.html' : 'customer-dashboard.html';
            window.location.href = destination;
        } else {
            window.location.href = 'auth.html';
        }
    };

    window.handleProfileClick = function() {
        const isAdmin = localStorage.getItem('purely_is_admin') === 'true';
        const confirmed = confirm('Click OK to go to dashboard or Cancel to logout');
        if (confirmed) {
            const destination = isAdmin ? 'admin-dashboard.html' : 'customer-dashboard.html';
            window.location.href = destination;
        } else {
            window.handleLogout();
        }
    };

    window.handleLogout = function() {
        localStorage.removeItem('purely_current_user');
        localStorage.removeItem('supabase_session');
        localStorage.removeItem('purely_is_admin');
        window.updateNavbarAuth();
        window.location.href = 'index.html';
    };

    window.updateNavbarAuth = function() {
        const user = JSON.parse(localStorage.getItem('purely_current_user'));
        const isAdmin = localStorage.getItem('purely_is_admin') === 'true';
        const loginBtn = document.getElementById('login-btn');
        const userBtn = document.getElementById('user-profile-btn');
        
        console.log('Updating navbar auth - user:', user ? user.name : 'none', 'admin:', isAdmin);
        
        if (loginBtn && userBtn) {
            if (user && user.name) {
                loginBtn.style.display = 'none';
                userBtn.style.display = 'block';
                const roleLabel = isAdmin ? ' (Admin)' : '';
                userBtn.textContent = 'üë§ ' + user.name + roleLabel;
                console.log('‚úì User logged in as:', user.name);
            } else {
                loginBtn.style.display = 'block';
                userBtn.style.display = 'none';
                console.log('‚úì User not logged in');
            }
        } else {
            console.warn('Navbar elements not found yet');
        }
    };
    
    // Call update immediately
    window.updateNavbarAuth();
    
    // Listen for storage changes (login from other tabs)
    window.addEventListener('storage', window.updateNavbarAuth);
    
    // Search functionality
    let allProducts = [];
    
    window.openSearchModal = async function() {
        const modal = document.getElementById('search-modal');
        modal.style.display = 'flex';
        document.getElementById('search-input').focus();
        
        // Fetch products if not already loaded
        if (allProducts.length === 0) {
            try {
                const SUPABASE_URL = 'https://srcnlbdybejvcbvvdpbk.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyY25sYmR5YmVqdmNidnZkcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0OTU3MDYsImV4cCI6MjA4NTA3MTcwNn0.qLj0ClnWgAfxbtZ1P6O2c6TELdevpqerqOnjKGqhaZ8';
                
                const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data } = await sb.from('products').select('*');
                allProducts = data || [];
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        }
    };
    
    window.closeSearchModal = function() {
        document.getElementById('search-modal').style.display = 'none';
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
    };
    
    window.performSearch = function(query) {
        const resultsContainer = document.getElementById('search-results');
        
        if (!query.trim()) {
            resultsContainer.innerHTML = '';
            return;
        }
        
        const filtered = allProducts.filter(product => 
            product.name.toLowerCase().includes(query.toLowerCase()) ||
            product.description.toLowerCase().includes(query.toLowerCase())
        );
        
        if (filtered.length === 0) {
            resultsContainer.innerHTML = '<p style="text-align: center; color: #999;">No products found</p>';
            return;
        }
        
        resultsContainer.innerHTML = filtered.map(product => `
            <div class="search-result-item">
                <img src="${product.image_url || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'}" alt="${product.name}">
                <div class="search-result-info">
                    <h4>${product.name}</h4>
                    <p>${product.description.substring(0, 60)}...</p>
                    <p class="search-result-price">$${product.price.toFixed(2)}</p>
                </div>
                <button class="search-result-btn" onclick="window.location.href='products.html?search=${encodeURIComponent(product.name)}'">View</button>
            </div>
        `).join('');
    };
    
    // Close modal when clicking outside
    document.getElementById('search-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            window.closeSearchModal();
        }
    });
    
    // Hide search icon on about and contact pages
    window.hideSearchIconIfNeeded = function() {
        const currentPage = window.location.pathname;
        if (currentPage.includes('about.html') || currentPage.includes('contact.html')) {
            const searchIcon = document.getElementById('search-icon');
            if (searchIcon) {
                searchIcon.style.display = 'none';
            }
        }
    };
    
    // Call immediately and also after a short delay to ensure DOM is ready
    window.hideSearchIconIfNeeded();
    setTimeout(window.hideSearchIconIfNeeded, 100);
    
    // Also add observer for when localStorage changes in same window
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        if (key === 'purely_current_user' || key === 'purely_is_admin') {
            console.log('localStorage changed:', key);
            window.updateNavbarAuth();
        }
        return originalSetItem.call(localStorage, key, value);
    };
</script>